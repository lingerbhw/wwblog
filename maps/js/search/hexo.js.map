{"version":3,"file":"../../../js/search/hexo.js","names":["SearchService","fn","div","document","createElement","innerHTML","template","body","append","querySelectorAll","forEach","e","addEventListener","onSubmit","querySelector","close","event","preventDefault","input","target","queryText","value","search","async","style","display","data","fetchData","results","buildResultList","pages","posts","window","pjax","refresh","f","code","removeEventListener","fetch","SearchServiceDataPath","then","response","text","res","JSON","parse","html","post","replace","title","trim","slice","contentSearch","buildResult","permalink","digest","post_title","toLowerCase","post_content","keywords","split","foundMatch","index_title","index_content","first_occur","word","index","indexOf","start","end","Math","max","min","length","match_content","substring","keyword","regS","RegExp","url","getUrlRelativePath","arrUrl","relUrl","init","setQueryText","Object","freeze"],"sources":["js/search/hexo.js"],"mappings":"AAAA,IAAIA,cAAgB,MAClB,MAAMC,EAAK,CACXA,UAAe,KACfA,KAAU,KACVA,SAAc,usBAkBdA,KAAU,KACR,IAAIC,EAAMC,SAASC,cAAc,OACjCF,EAAIG,WAAaJ,EAAGK,SACpBH,SAASI,KAAKC,OAAON,GACrBC,SAASM,iBAAiB,kBAAkBC,SAASC,IACnDA,EAAEC,iBAAiB,SAAUX,EAAGY,UAAU,EAAM,IAE1BV,SAASW,cAAc,yBAC7BF,iBAAiB,QAASX,EAAGY,UAC/CV,SACGW,cAAc,uBACdF,iBAAiB,QAASX,EAAGc,OAAO,GACvCZ,SACGW,cAAc,kBACdF,iBAAiB,QAASX,EAAGc,OAAO,EAAM,EAE/Cd,SAAee,IACbA,EAAMC,iBACN,IAAIC,EAAQF,EAAMG,OAAOL,cAAc,mBAErCb,EAAGmB,UADDF,EACaA,EAAMG,MAENL,EAAMG,OAAOE,MAG1BpB,EAAGmB,WACLnB,EAAGqB,QACL,EAEFrB,OAAYsB,UACVpB,SAASM,iBAAiB,mBAAmBC,SAASC,IACpDA,EAAEU,MAAQpB,EAAGmB,SAAS,IAExBjB,SAASW,cAAc,aAAaU,MAAMC,QAAU,QAC/CxB,EAAGyB,OACNzB,EAAGyB,WAAazB,EAAG0B,aAErB,IAAIC,EAAU,GACdA,GAAW3B,EAAG4B,gBAAgB5B,EAAGyB,KAAKI,OACtCF,GAAW3B,EAAG4B,gBAAgB5B,EAAGyB,KAAKK,OACtC5B,SAASW,cAAc,4BAA4BT,UAAYuB,EAC/DI,OAAOC,MAAQA,KAAKC,QAAQ/B,SAASW,cAAc,cACnDX,SAASS,iBAAiB,WAAW,SAASuB,EAAEnB,GAC3B,WAAfA,EAAMoB,OACRnC,EAAGc,QACHZ,SAASkC,oBAAoB,UAAWF,GAE5C,GAAE,EAEJlC,MAAW,KACTE,SAASW,cAAc,aAAaU,MAAMC,QAAU,MAAM,EAE5DxB,UAAe,IACNqC,MAAMC,uBACVC,MAAMC,GAAaA,EAASC,SAC5BF,MAAMG,GACQC,KAAKC,MAAMF,KAK9B1C,gBAAsByB,IACpB,IAAIoB,EAAO,GAYX,OAXApB,EAAKhB,SAASqC,IACRA,EAAKL,OACPK,EAAKL,KAAOK,EAAKL,KAAKM,QAAQ,YAAa,MAExCD,EAAKE,OAASF,EAAKL,OACtBK,EAAKE,MAAQF,EAAKL,KAAKQ,OAAOC,MAAM,EAAG,KAErClD,EAAGmD,cAAcL,KACnBD,GAAQ7C,EAAGoD,YAAYN,EAAKO,UAAWP,EAAKE,MAAOF,EAAKQ,QAC1D,IAEKT,CAAI,EAEb7C,cAAoB8C,IAClB,IAAIS,EAAaT,EAAKE,MAAMC,OAAOO,cAC/BC,EAAeX,EAAKL,KAAKQ,OAAOO,cAChCE,EAAW1D,EAAGmB,UACf8B,OACAO,cACAG,MAAM,UACLC,GAAa,EACbC,GAAe,EACfC,GAAiB,EACjBC,GAAe,EA0CnB,OAzCIR,GAAcE,GAChBC,EAASjD,SAAQ,CAACuD,EAAMC,KActB,GAbAJ,EAAcN,EAAWW,QAAQF,GACjCF,EAAgBL,EAAaS,QAAQF,GACjCH,EAAc,GAAKC,EAAgB,EACrCF,GAAa,GAEbA,GAAa,EACTE,EAAgB,IAClBA,EAAgB,GAEJ,IAAVG,IACFF,EAAcD,IAGdF,EAAY,CACdH,EAAeX,EAAKL,KAAKQ,OACzB,IAAIkB,EAAQ,EACRC,EAAM,EACV,GAAIL,GAAe,EAAG,CACpBI,EAAQE,KAAKC,IAAIP,EAAc,GAAI,GACnCK,EACY,IAAVD,EACIE,KAAKE,IAAI,IAAKd,EAAae,QAC3BH,KAAKE,IAAIR,EAAc,IAAKN,EAAae,QAC/C,IAAIC,EAAgBhB,EAAaiB,UAAUP,EAAOC,GAClDV,EAASjD,SAAQ,SAAUkE,GACzB,IAAIC,EAAO,IAAIC,OAAOF,EAAS,MAC/BF,EAAgBA,EAAc1B,QAC5B6B,EACA,WAAaD,EAAU,OAE3B,IACA7B,EAAKQ,OAASmB,EAAgB,QAChC,MACEL,EAAMC,KAAKE,IAAI,IAAKd,EAAae,QACjC1B,EAAKQ,OAASG,EAAaR,OAAOyB,UAAU,EAAGN,EAEnD,KAGGR,CAAU,EAEnB5D,YAAiB,CAAC8E,EAAK9B,EAAOM,KAC5B,IACIT,EAAO,GAQX,OAPAA,GAAQ,OACRA,GACE,2BAJW7C,EAAG+E,mBAAmBD,GAIK,YAAc9E,EAAGmB,UAAY,KACrE0B,GAAQ,uBAAyBG,EAAQ,UAC1B,KAAXM,IAAeT,GAAQ,wBAA0BS,EAAS,WAC9DT,GAAQ,OACRA,GAAQ,QACDA,CAAI,EAEb7C,mBAAwB,SAAU8E,GAChC,IAAIE,EAASF,EAAInB,MAAM,MACnBQ,EAAQa,EAAO,GAAGd,QAAQ,KAC1Be,EAASD,EAAO,GAAGN,UAAUP,GAIjC,OAH4B,GAAxBc,EAAOf,QAAQ,OACjBe,EAASA,EAAOtB,MAAM,KAAK,IAEtBsB,CACT,GACA,MAAO,CACLC,KAAM,KACJlF,EAAGkF,MAAM,EAEXC,aAAehE,IACbnB,EAAGmB,UAAYA,CAAS,EAE1BE,OAAQ,KACNrB,EAAGqB,QAAQ,EAGhB,EAxLmB,GAyLpB+D,OAAOC,OAAOtF,eAEdA,cAAcmF,OACdhF,SAASS,iBAAiB,eAAgBZ,cAAcmF,MACxDhF,SAASS,iBAAiB,aAAa,WACrCT,SAASW,cAAc,aAAaU,MAAMC,QAAU,MACtD","sourcesContent":["let SearchService = (() => {\n  const fn = {};\n  fn.queryText = null;\n  fn.data = null;\n  fn.template = `<div id=\"u-search\">\n  <div class=\"modal\">\n    <header class=\"modal-header\" class=\"clearfix\">\n      <form id=\"u-search-modal-form\" class=\"u-search-form\" name=\"uSearchModalForm\">\n        <input type=\"text\" id=\"u-search-modal-input\" class=\"u-search-input\" />\n        <button type=\"submit\" id=\"u-search-modal-btn-submit\" class=\"u-search-btn-submit\">\n          <span class=\"fa-solid fa-search\"></span>\n        </button>\n      </form>\n      <a id=\"u-search-btn-close\" class=\"btn-close\"> <span class=\"fa-solid fa-times\"></span> </a>\n    </header>\n    <main class=\"modal-body\">\n      <ul class=\"modal-results\"></ul>\n    </main>\n  </div>\n  <div id=\"modal-overlay\" class=\"modal-overlay\"></div>\n</div>\n`;\n  fn.init = () => {\n    let div = document.createElement(\"div\");\n    div.innerHTML += fn.template;\n    document.body.append(div);\n    document.querySelectorAll(\".u-search-form\").forEach((e) => {\n      e.addEventListener(\"submit\", fn.onSubmit, false);\n    });\n    let uSearchModalInput = document.querySelector(\"#u-search-modal-input\");\n    uSearchModalInput.addEventListener(\"input\", fn.onSubmit);\n    document\n      .querySelector(\"#u-search-btn-close\")\n      .addEventListener(\"click\", fn.close, false);\n    document\n      .querySelector(\"#modal-overlay\")\n      .addEventListener(\"click\", fn.close, false);\n  };\n  fn.onSubmit = (event) => {\n    event.preventDefault();\n    let input = event.target.querySelector(\".u-search-input\");\n    if (input) {\n      fn.queryText = input.value;\n    } else {\n      fn.queryText = event.target.value;\n    }\n\n    if (fn.queryText) {\n      fn.search();\n    }\n  };\n  fn.search = async () => {\n    document.querySelectorAll(\".u-search-input\").forEach((e) => {\n      e.value = fn.queryText;\n    });\n    document.querySelector(\"#u-search\").style.display = \"block\";\n    if (!fn.data) {\n      fn.data = await fn.fetchData();\n    }\n    let results = \"\";\n    results += fn.buildResultList(fn.data.pages);\n    results += fn.buildResultList(fn.data.posts);\n    document.querySelector(\"#u-search .modal-results\").innerHTML = results;\n    window.pjax && pjax.refresh(document.querySelector(\"#u-search\"));\n    document.addEventListener(\"keydown\", function f(event) {\n      if (event.code === \"Escape\") {\n        fn.close();\n        document.removeEventListener(\"keydown\", f);\n      }\n    });\n  };\n  fn.close = () => {\n    document.querySelector(\"#u-search\").style.display = \"none\";\n  };\n  fn.fetchData = () => {\n    return fetch(SearchServiceDataPath)\n      .then((response) => response.text())\n      .then((res) => {\n        const data = JSON.parse(res);\n        // console.log(data);\n        return data;\n      });\n  };\n  fn.buildResultList = (data) => {\n    let html = \"\";\n    data.forEach((post) => {\n      if (post.text) {\n        post.text = post.text.replace(/12345\\d*/g, \"\") // 简易移除代码行号\n      }\n      if (!post.title && post.text) {\n        post.title = post.text.trim().slice(0, 15)\n      }\n      if (fn.contentSearch(post)) {\n        html += fn.buildResult(post.permalink, post.title, post.digest);\n      }\n    });\n    return html;\n  };\n  fn.contentSearch = (post) => {\n    let post_title = post.title.trim().toLowerCase();\n    let post_content = post.text.trim().toLowerCase();\n    let keywords = fn.queryText\n      .trim()\n      .toLowerCase()\n      .split(/[-\\s]+/);\n    let foundMatch = false;\n    let index_title = -1;\n    let index_content = -1;\n    let first_occur = -1;\n    if (post_title && post_content) {\n      keywords.forEach((word, index) => {\n        index_title = post_title.indexOf(word);\n        index_content = post_content.indexOf(word);\n        if (index_title < 0 && index_content < 0) {\n          foundMatch = false;\n        } else {\n          foundMatch = true;\n          if (index_content < 0) {\n            index_content = 0;\n          }\n          if (index === 0) {\n            first_occur = index_content;\n          }\n        }\n        if (foundMatch) {\n          post_content = post.text.trim();\n          let start = 0;\n          let end = 0;\n          if (first_occur >= 0) {\n            start = Math.max(first_occur - 40, 0);\n            end =\n              start === 0\n                ? Math.min(200, post_content.length)\n                : Math.min(first_occur + 120, post_content.length);\n            let match_content = post_content.substring(start, end);\n            keywords.forEach(function (keyword) {\n              let regS = new RegExp(keyword, \"gi\");\n              match_content = match_content.replace(\n                regS,\n                \"<b mark>\" + keyword + \"</b>\"\n              );\n            });\n            post.digest = match_content + \"......\";\n          } else {\n            end = Math.min(200, post_content.length);\n            post.digest = post_content.trim().substring(0, end);\n          }\n        }\n      });\n    }\n    return foundMatch;\n  };\n  fn.buildResult = (url, title, digest) => {\n    let result = fn.getUrlRelativePath(url);\n    let html = \"\";\n    html += \"<li>\";\n    html +=\n      \"<a class='result' href='\" + result + \"?keyword=\" + fn.queryText + \"'>\";\n    html += \"<span class='title'>\" + title + \"</span>\";\n    if (digest !== \"\") html += \"<span class='digest'>\" + digest + \"</span>\";\n    html += \"</a>\";\n    html += \"</li>\";\n    return html;\n  };\n  fn.getUrlRelativePath = function (url) {\n    let arrUrl = url.split(\"//\");\n    let start = arrUrl[1].indexOf(\"/\");\n    let relUrl = arrUrl[1].substring(start);\n    if (relUrl.indexOf(\"?\") != -1) {\n      relUrl = relUrl.split(\"?\")[0];\n    }\n    return relUrl;\n  };\n  return {\n    init: () => {\n      fn.init();\n    },\n    setQueryText: (queryText) => {\n      fn.queryText = queryText;\n    },\n    search: () => {\n      fn.search();\n    },\n  };\n})();\nObject.freeze(SearchService);\n\nSearchService.init();\ndocument.addEventListener(\"pjax:success\", SearchService.init);\ndocument.addEventListener(\"pjax:send\", function () {\n  document.querySelector(\"#u-search\").style.display = \"none\";\n});\n"]}